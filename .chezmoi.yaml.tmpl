{{- /*
Other useful apps:
- btop
- cloc
- dog
- duf
- dust
- yq
*/ -}}
{{- $apps := list
      "aws"
      "bat"
      "brew"
      "bw"
      "cargo"
      "chezmoi"
      "delta"
      "eza"
      "fd"
      "fish"
      "fzf"
      "git"
      "go"
      "gpg"
      "jq"
      "kitty"
      "kubectl"
      "podman"
      "python3"
      "ranger"
      "rg"
      "starship"
      "tmux"
      "vim"
      "yc"
-}}

{{- $homePath := list
      (joinPath .chezmoi.homeDir ".local/bin")
      (joinPath .chezmoi.homeDir ".cargo/bin")
      (joinPath .chezmoi.homeDir ".go/bin")
-}}
{{- $path := concat (splitList ":" (env "PATH")) $homePath -}}
{{- if eq .chezmoi.os "darwin" -}}
{{-   $path = append $path "/opt/homebrew/bin" -}}
{{- end -}}

{{- $binaries := dict -}}
{{- range $apps -}}
{{-   $_ := set $binaries . (findExecutable . $path) -}}
{{- end -}}

{{- $hostType := promptChoiceOnce . "hostType" "What type of host are you on" (list "desktop" "server") (dig "hostType" "desktop" .) -}}

{{- $sshKeysUrl := dig "ssh" "keysUrl" "" . -}}
{{- if eq $hostType "server" -}}
{{-   $sshKeysUrl = promptStringOnce . "ssh.keysUrl" "Which URL use to fetch public SSH keys" $sshKeysUrl -}}
{{- else -}}
{{-   $sshKeysUrl = "" -}}
{{- end -}}

{{- $gpgSearchTerm := dig "gpg" "searchTerm" "gpg" . -}}
{{- $gpgMainKeyId := dig "gpg" "mainKeyId" "" . -}}
{{- if and $binaries.gpg $binaries.bw (eq $hostType "desktop") -}}
{{-   $prevGpgSearchTerm := $gpgSearchTerm -}}
{{-   $gpgSearchTerm = promptStringOnce . "gpg.searchTerm" "What is the search term or ID for GPG key in Bitwarden" $gpgSearchTerm -}}
{{-   if or (not $gpgMainKeyId) (ne $gpgSearchTerm $prevGpgSearchTerm) (promptBoolOnce . "gpg.refresh" "Do you need to refresh GPG key" false) -}}
{{-     $gpgKey := (bitwarden "item" $gpgSearchTerm).notes -}}
{{-     $gpgPackets := output "sh" "-c" (printf "printf -- %s | gpg --list-packets" ($gpgKey | quote)) -}}
{{-     $gpgMainKeyId = $gpgPackets | regexFind "keyid: [0-9A-F]{16}" | substr 7 23 -}}
{{-   end -}}
{{- else -}}
{{-   $gpgSearchTerm = "" -}}
{{-   $gpgMainKeyId = "" -}}
{{- end -}}

{{- $gitName := dig "git" "name" "" . -}}
{{- $gitEmail := dig "git" "email" "" . -}}
{{- if $binaries.git -}}
{{-   $gitName = promptStringOnce . "git.name" "What is your name for git" $gitName -}}
{{-   $gitEmail = promptStringOnce . "git.email" "What is your email for git" $gitEmail -}}
{{- end -}}

data:
  binaries:
    {{- toYaml $binaries | trim | nindent 4 }}
  features:
    fishFzf: {{ all $binaries.fish $binaries.fzf $binaries.fd $binaries.bat }}
  hostType: {{ $hostType | quote }}
  ssh:
    keysUrl: {{ $sshKeysUrl | quote }}
  gpg:
    searchTerm: {{ $gpgSearchTerm | quote }}
    mainKeyId: {{ $gpgMainKeyId | quote }}
    refresh: false
  git:
    name: {{ $gitName | quote }}
    email: {{ $gitEmail | quote }}

{{ if $binaries.bw -}}
bitwarden:
  unlock: true

{{ end -}}

{{ if $binaries.delta -}}
diff:
  pager: delta

{{ end -}}

